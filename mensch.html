
<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Mensch ärgere Dich nicht</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: Arial, sans-serif; background: #111; color: white; text-align: center; padding: 2rem; }
    table { margin: auto; border-collapse: collapse; margin-top: 2rem; }
    th, td { border: 1px solid white; padding: 0.5rem; min-width: 80px; }
    input, select, button { margin: 0.2rem; padding: 0.4rem; }
    .highlight { background-color: gold; color: black; font-weight: bold; }
    #zurueck { position: absolute; top: 1rem; left: 1rem; background: #444; color: white; padding: 0.5rem 1rem; border-radius: 5px; text-decoration: none; }
  </style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<a href="index.html" id="zurueck">← Zurück</a>
<h1>Mensch ärgere Dich nicht</h1>

<div id="spielerBereich">
  <h3>Spieler hinzufügen</h3>
  <div id="spielerEingabe"></div>
  <button onclick="spielerHinzufuegen()">+ Spieler hinzufügen</button>
</div>

<h3>Rundentabelle</h3>
<table id="spielTabelle">
  <thead><tr id="kopfzeile"><th>Runde</th></tr></thead>
  <tbody id="spielBody"></tbody>
</table>
<canvas id="siegChart" width="400" height="200" style="margin-top:2rem;"></canvas>
<button onclick="neueRunde()">+ Neue Runde</button>

<h3>Siege in 'Mensch ärgere Dich nicht'</h3>
<table id="siegTabelle">
  <tr><th>Spieler</th><th>Siege</th></tr>
</table>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import {
    getFirestore, collection, getDocs, addDoc
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDy68MUU2CV9-tCsu9qbKBd7NEL-MGNxX0",
    authDomain: "gambling-app-24-7.firebaseapp.com",
    projectId: "gambling-app-24-7",
    storageBucket: "gambling-app-24-7.appspot.com",
    messagingSenderId: "929710119993",
    appId: "1:929710119993:web:b4678cc49c503c332701e8"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  let spielerCount = 2;
  const maxSpieler = 6;
  let rundenCounter = 1;
  const spielerDropdowns = [];

  function createSpielerDropdown(index) {
    const select = document.createElement("select");
    select.innerHTML = `<option disabled selected>Spieler ${index + 1}</option>`;
    fetchAlleSpieler().then(namen => {
      namen.forEach(name => {
        const option = document.createElement("option");
        option.textContent = name;
        option.value = name;
        select.appendChild(option);
      });
    });
    select.classList.add("spielerSelect");
    return select;
  }

  function spielerHinzufuegen() {
    if (spielerDropdowns.length >= maxSpieler) return;
    const container = document.getElementById("spielerEingabe");
    const index = spielerDropdowns.length;
    const dropdown = createSpielerDropdown(index);
    container.appendChild(dropdown);
    spielerDropdowns.push(dropdown);
    updateTabellenKopf();
  }

  function updateTabellenKopf() {
    const kopf = document.getElementById("kopfzeile");
    kopf.innerHTML = "<th>Runde</th>";
    spielerDropdowns.forEach(drop => {
      kopf.innerHTML += `<th>${drop.value || drop.options[0].text}</th>`;
    });
  }

  function neueRunde() {
    const body = document.getElementById("spielBody");
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${rundenCounter++}</td>`;
    spielerDropdowns.forEach(() => {
      tr.innerHTML += `<td><input type="number" style="width:60px"/></td>`;
    });
    body.appendChild(tr);
  }

  async function fetchAlleSpieler() {
    const resultSet = new Set();
    const snapshot = await getDocs(collection(db, "gameResults"));
    snapshot.forEach(doc => {
      const data = doc.data();
      if (data.winner) {
        (Array.isArray(data.winner) ? data.winner : [data.winner]).forEach(name => resultSet.add(name));
      }
    });
    return [...resultSet];
  }

  async function ladeSiege() {
    const siegerMap = {};
    const querySnapshot = await getDocs(collection(db, "gameResults"));
    querySnapshot.forEach((doc) => {
      const data = doc.data();
      if (data.winner && data.game === "Mensch") {
        if (Array.isArray(data.winner)) {
          data.winner.forEach(w => siegerMap[w] = (siegerMap[w] || 0) + 1);
        } else {
          siegerMap[data.winner] = (siegerMap[data.winner] || 0) + 1;
        }
      }
    });
    const siegArray = Object.entries(siegerMap).sort((a, b) => b[1] - a[1]);
    const table = document.getElementById("siegTabelle");
    
    const ctx = document.getElementById('siegChart').getContext('2d');
    const chartData = {
      labels: siegArray.map(([spieler]) => spieler),
      datasets: [{
        label: 'Siege',
        data: siegArray.map(([, siege]) => siege),
        borderWidth: 1
      }]
    };
    new Chart(ctx, {
      type: 'bar',
      data: chartData,
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });

    siegArray.forEach(([spieler, siege]) => {
      const row = document.createElement("tr");
      row.innerHTML = `<td>${spieler}</td><td>${siege}</td>`;
      table.appendChild(row);
    });
  }

  spielerHinzufuegen();
  spielerHinzufuegen();
  neueRunde();
  ladeSiege();
</script>
</body>
</html>
